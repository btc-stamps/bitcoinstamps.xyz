name: CI - LEO API Quality Assurance

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  leo-validation:
    name: LEO API System Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build with LEO API System
        run: npm run docs:build
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Run LEO API Tests
        run: npm run test:leo-api

      - name: Validate Generated API Files
        run: |
          echo "üîç Validating generated API files..."
          
          # Check that all expected API files exist
          if [[ ! -f "dist/api/entities.json" ]]; then
            echo "‚ùå entities.json not generated"
            exit 1
          fi
          
          if [[ ! -f "dist/api/protocols.json" ]]; then
            echo "‚ùå protocols.json not generated"
            exit 1
          fi
          
          if [[ ! -f "dist/api/schema.json" ]]; then
            echo "‚ùå schema.json not generated"
            exit 1
          fi
          
          # Validate JSON structure
          echo "üìã Validating JSON structure..."
          jq empty dist/api/entities.json || (echo "‚ùå Invalid entities.json" && exit 1)
          jq empty dist/api/protocols.json || (echo "‚ùå Invalid protocols.json" && exit 1)
          jq empty dist/api/schema.json || (echo "‚ùå Invalid schema.json" && exit 1)
          
          # Check for required content
          echo "üîç Validating content completeness..."
          
          # Verify KEVIN data is present
          if ! jq -e '.protocols[] | select(.id == "src-20" and .community.holders > 2000)' dist/api/protocols.json > /dev/null; then
            echo "‚ùå KEVIN/SRC-20 community data missing or incomplete"
            exit 1
          fi
          
          # Verify cultural entities exist
          if ! jq -e '.entities.concepts[] | select(.id == "kevin")' dist/api/entities.json > /dev/null; then
            echo "‚ùå KEVIN entity missing from entities.json"
            exit 1
          fi
          
          # Verify ecosystem economics data
          if ! jq -e '.metadata.ecosystem | select(.totalSRC20Volume and .bitcoinVolume)' dist/api/protocols.json > /dev/null; then
            echo "‚ùå Ecosystem economics data incomplete"
            exit 1
          fi
          
          echo "‚úÖ All API files validated successfully"

      - name: Check Structured Data Coverage
        run: |
          echo "üìä Checking structured data coverage..."

          # Only check actual content directories (en/es/fr/zh/tr), exclude internal tooling
          CONTENT_DIRS="docs/en docs/es docs/fr docs/zh docs/tr"
          SMART_DATA_COUNT=0
          TOTAL_MD_FILES=0

          for dir in $CONTENT_DIRS; do
            if [[ -d "$dir" ]]; then
              DIR_TOTAL=$(find "$dir" -name "*.md" -not -path "*/api/*" | wc -l)
              DIR_SMART=$(grep -rl "SmartStructuredData" "$dir" --include="*.md" 2>/dev/null | wc -l)
              TOTAL_MD_FILES=$((TOTAL_MD_FILES + DIR_TOTAL))
              SMART_DATA_COUNT=$((SMART_DATA_COUNT + DIR_SMART))
            fi
          done

          echo "SmartStructuredData coverage: $SMART_DATA_COUNT / $TOTAL_MD_FILES content files"

          if [[ $TOTAL_MD_FILES -eq 0 ]]; then
            echo "‚ö†Ô∏è No content files found ‚Äî skipping coverage check"
            exit 0
          fi

          COVERAGE_PERCENT=$(( SMART_DATA_COUNT * 100 / TOTAL_MD_FILES ))

          # Check English content separately (primary language, should be high coverage)
          EN_TOTAL=$(find docs/en -name "*.md" -not -path "*/api/*" 2>/dev/null | wc -l)
          EN_SMART=$(grep -rl "SmartStructuredData" docs/en --include="*.md" 2>/dev/null | wc -l)
          EN_PERCENT=0
          if [[ $EN_TOTAL -gt 0 ]]; then
            EN_PERCENT=$(( EN_SMART * 100 / EN_TOTAL ))
          fi

          echo "English coverage: $EN_SMART / $EN_TOTAL ($EN_PERCENT%)"
          echo "Overall coverage: $SMART_DATA_COUNT / $TOTAL_MD_FILES ($COVERAGE_PERCENT%)"

          if [[ $COVERAGE_PERCENT -lt 80 ]]; then
            echo "‚ö†Ô∏è Overall coverage below 80% ‚Äî translations in progress"
            echo "Missing files:"
            for dir in $CONTENT_DIRS; do
              if [[ -d "$dir" ]]; then
                find "$dir" -name "*.md" -not -path "*/api/*" -exec grep -L "SmartStructuredData" {} \;
              fi
            done
            echo "Note: Coverage check is informational while i18n is in progress"
          fi

          echo "‚úÖ Structured data coverage check complete"

      - name: Validate LEO Frontmatter
        run: |
          echo "üè∑Ô∏è  Validating LEO frontmatter fields..."

          # Only check English content (primary language, others may be incomplete translations)
          MISSING_LEO_TYPE=$(find docs/en -name "*.md" -not -path "*/api/*" -exec grep -L "leoType:" {} \; | wc -l)
          MISSING_AUDIENCE=$(find docs/en -name "*.md" -not -path "*/api/*" -exec grep -L "audience:" {} \; | wc -l)

          if [[ $MISSING_LEO_TYPE -gt 0 ]]; then
            echo "‚ö†Ô∏è English files missing leoType field:"
            find docs/en -name "*.md" -not -path "*/api/*" -exec grep -L "leoType:" {} \;
            echo "This is a warning ‚Äî not blocking CI until all content is migrated"
          fi

          if [[ $MISSING_AUDIENCE -gt 0 ]]; then
            echo "‚ö†Ô∏è English files missing audience field:"
            find docs/en -name "*.md" -not -path "*/api/*" -exec grep -L "audience:" {} \;
            echo "This is a warning ‚Äî not blocking CI until all content is migrated"
          fi

          echo "‚úÖ LEO frontmatter validation complete"

      - name: Check Multilingual File Parity
        run: |
          echo "üåç Checking multilingual file parity..."
          EN_FILES=$(find docs/en -name "*.md" | sed 's|docs/en/||' | sort)
          FAIL=0
          for lang in es fr zh tr; do
            LANG_FILES=$(find docs/$lang -name "*.md" | sed "s|docs/$lang/||" | sort)
            MISSING=$(comm -23 <(echo "$EN_FILES") <(echo "$LANG_FILES"))
            if [ -n "$MISSING" ]; then
              echo "‚ö†Ô∏è $lang missing files:"
              echo "$MISSING" | sed 's/^/  /'
              FAIL=1
            fi
          done
          if [ $FAIL -eq 1 ]; then
            echo "‚ö†Ô∏è Multilingual file parity check found gaps (non-blocking)"
          else
            echo "‚úÖ All languages have matching file structure"
          fi

      - name: Test API Performance
        run: |
          echo "‚ö° Testing API file sizes for performance..."
          
          # Check that API files aren't too large
          MAX_SIZE=500000  # 500KB max per API file
          
          for file in dist/api/*.json; do
            if [[ -f "$file" ]]; then
              SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
              if [[ $SIZE -gt $MAX_SIZE ]]; then
                echo "‚ùå API file too large: $(basename $file) = ${SIZE}B (max: ${MAX_SIZE}B)"
                exit 1
              fi
              echo "‚úÖ $(basename $file): ${SIZE}B"
            fi
          done
          
          echo "‚úÖ All API files within size limits"

      - name: Upload API Artifacts for Review
        uses: actions/upload-artifact@v4
        with:
          name: leo-api-files
          path: |
            dist/api/
            docs/.vitepress/api/compiled/
          retention-days: 30

      - name: Upload Full Build for Lighthouse
        uses: actions/upload-artifact@v4
        with:
          name: dist-full
          path: dist/
          retention-days: 1

  lighthouse-audit:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    needs: leo-validation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist-full
          path: dist/

      - name: Run Lighthouse CI
        run: npm run lighthouse

      - name: Upload Lighthouse Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 30